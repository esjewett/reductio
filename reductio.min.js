// https://github.com/esjewett/reductio v0.6.3 Copyright 2019 Ethan Jewett
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("crossfilter2")):"function"==typeof define&&define.amd?define(["crossfilter2"],n):(e=e||self).reductio=n(e.crossfilter)}(this,(function(e){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var n={add:function(e,n,t){return function(r,u,i){return e(u,i)?n&&n(r,u,i):t&&t(r,u,i),r}},remove:function(e,n,t){return function(r,u,i){return e(u,i)?n&&n(r,u,i):t&&t(r,u,i),r}}},t={add:function(e,n,t){return function(r,u,i){return e&&e(r,u,i),n(r)[t]++,r}},remove:function(e,n,t){return function(r,u,i){return e&&e(r,u,i),n(r)[t]--,r}},initial:function(e,n,t){return function(r){return e&&(r=e(r)),n(r)[t]=0,r}}},r={add:function(e,n,t){return function(r,u,i){return n&&n(r,u,i),t(r).sum=t(r).sum+e(u),r}},remove:function(e,n,t){return function(r,u,i){return n&&n(r,u,i),t(r).sum=t(r).sum-e(u),r}},initial:function(e,n){return function(t){return t=e(t),n(t).sum=0,t}}},u={add:function(e,n,t){return function(e,r,u){return n&&n(e,r,u),t(e).count>0?t(e).avg=t(e).sum/t(e).count:t(e).avg=0,e}},remove:function(e,n,t){return function(e,r,u){return n&&n(e,r,u),t(e).count>0?t(e).avg=t(e).sum/t(e).count:t(e).avg=0,e}},initial:function(e,n){return function(t){return t=e(t),n(t).avg=0,t}}},i={add:function(e,n){var t;return function(r,u,i){return e&&e(r,u,i),t=Math.floor(n(r).valueList.length/2),n(r).valueList.length%2?n(r).median=n(r).valueList[t]:n(r).median=(n(r).valueList[t-1]+n(r).valueList[t])/2,r}},remove:function(e,n){var t;return function(r,u,i){return e&&e(r,u,i),t=Math.floor(n(r).valueList.length/2),0===n(r).valueList.length?(n(r).median=void 0,r):(1===n(r).valueList.length||n(r).valueList.length%2?n(r).median=n(r).valueList[t]:n(r).median=(n(r).valueList[t-1]+n(r).valueList[t])/2,r)}},initial:function(e,n){return function(t){return t=e(t),n(t).median=void 0,t}}},o={add:function(e,n){return function(t,r,u){return e&&e(t,r,u),n(t).min=n(t).valueList[0],t}},remove:function(e,n){return function(t,r,u){return e&&e(t,r,u),0===n(t).valueList.length?(n(t).min=void 0,t):(n(t).min=n(t).valueList[0],t)}},initial:function(e,n){return function(t){return t=e(t),n(t).min=void 0,t}}},c={add:function(e,n){return function(t,r,u){return e&&e(t,r,u),n(t).max=n(t).valueList[n(t).valueList.length-1],t}},remove:function(e,n){return function(t,r,u){return e&&e(t,r,u),0===n(t).valueList.length?(n(t).max=void 0,t):(n(t).max=n(t).valueList[n(t).valueList.length-1],t)}},initial:function(e,n){return function(t){return t=e(t),n(t).max=void 0,t}}},a={add:function(e,n,t){var r,u;return function(i,o,c){return n&&n(i,o,c),r=t(i).bisect(t(i).values,e(o),0,t(i).values.length),(u=t(i).values[r])&&u[0]===e(o)?u[1]++:t(i).values.splice(r,0,[e(o),1]),i}},remove:function(e,n,t){var r;return function(u,i,o){return n&&n(u,i,o),r=t(u).bisect(t(u).values,e(i),0,t(u).values.length),t(u).values[r][1]--,u}},initial:function(n,t){return function(r){return r=n(r),t(r).values=[],t(r).bisect=e.bisect.by((function(e){return e[0]})).left,r}}},s={add:function(n,t,r){var u,i=e.bisect.by((function(e){return e})).left;return function(e,o,c){return t&&t(e,o,c),u=i(r(e).valueList,n(o),0,r(e).valueList.length),r(e).valueList.splice(u,0,n(o)),e}},remove:function(n,t,r){var u,i=e.bisect.by((function(e){return e})).left;return function(e,o,c){return t&&t(e,o,c),u=i(r(e).valueList,n(o),0,r(e).valueList.length),r(e).valueList.splice(u,1),e}},initial:function(e,n){return function(t){return t=e(t),n(t).valueList=[],t}}},d={add:function(e,n,t){var r,u;return function(i,o,c){return n&&n(i,o,c),r=t(i).bisect(t(i).values,e(o),0,t(i).values.length),(u=t(i).values[r])&&u[0]===e(o)&&0!==u[1]||t(i).exceptionCount++,i}},remove:function(e,n,t){var r,u;return function(i,o,c){return n&&n(i,o,c),r=t(i).bisect(t(i).values,e(o),0,t(i).values.length),(u=t(i).values[r])&&u[0]===e(o)&&1===u[1]&&t(i).exceptionCount--,i}},initial:function(e,n){return function(t){return t=e(t),n(t).exceptionCount=0,t}}},l={add:function(e,n,t,r){var u,i;return function(o,c,a){return t&&t(o,c,a),u=r(o).bisect(r(o).values,e(c),0,r(o).values.length),(i=r(o).values[u])&&i[0]===e(c)&&0!==i[1]||(r(o).exceptionSum=r(o).exceptionSum+n(c)),o}},remove:function(e,n,t,r){var u,i;return function(o,c,a){return t&&t(o,c,a),u=r(o).bisect(r(o).values,e(c),0,r(o).values.length),(i=r(o).values[u])&&i[0]===e(c)&&1===i[1]&&(r(o).exceptionSum=r(o).exceptionSum-n(c)),o}},initial:function(e,n){return function(t){return t=e(t),n(t).exceptionSum=0,t}}},f={add:function(n,t,r){var u,i=e.bisect.by((function(e){return e})).left,o=e.bisect.by((function(e){return e.x})).right;return function(e,c,a){return t&&t(e,c,a),(u=r(e).histogram[o(r(e).histogram,n(c),0,r(e).histogram.length)-1]).y++,u.splice(i(u,n(c),0,u.length),0,n(c)),e}},remove:function(n,t,r){var u,i=e.bisect.by((function(e){return e})).left,o=e.bisect.by((function(e){return e.x})).right;return function(e,c,a){return t&&t(e,c,a),(u=r(e).histogram[o(r(e).histogram,n(c),0,r(e).histogram.length)-1]).y--,u.splice(i(u,n(c),0,u.length),1),e}},initial:function(e,n,t){return function(r){r=n(r),t(r).histogram=[];for(var u=[],i=1;i<e.length;i++)(u=[]).x=e[i-1],u.dx=e[i]-e[i-1],u.y=0,t(r).histogram.push(u);return r}}},v={add:function(e,n,t){return function(r,u,i){return n&&n(r,u,i),t(r).sumOfSq=t(r).sumOfSq+e(u)*e(u),r}},remove:function(e,n,t){return function(r,u,i){return n&&n(r,u,i),t(r).sumOfSq=t(r).sumOfSq-e(u)*e(u),r}},initial:function(e,n){return function(t){return t=e(t),n(t).sumOfSq=0,t}}},m={add:function(e,n){return function(t,r,u){if(e&&e(t,r,u),n(t).count>0){n(t).std=0;var i=n(t).sumOfSq-n(t).sum*n(t).sum/n(t).count;i>0&&(n(t).std=Math.sqrt(i/(n(t).count-1)))}else n(t).std=0;return t}},remove:function(e,n){return function(t,r,u){if(e&&e(t,r,u),n(t).count>0){n(t).std=0;var i=n(t).sumOfSq-n(t).sum*n(t).sum/n(t).count;i>0&&(n(t).std=Math.sqrt(i/(n(t).count-1)))}else n(t).std=0;return t}},initial:function(e,n){return function(t){return t=e(t),n(t).std=0,t}}},g={add:function(e,n,t){var r,u;return function(i,o,c){return n&&n(i,o,c),r=t(i).nest,e.forEach((function(e){(u=r.filter((function(n){return n.key===e(o)}))[0])?r=u.values:(u=[],r.push({key:e(o),values:u}),r=u)})),r.push(o),i}},remove:function(e,n,t){var r;return function(u,i,o){return n&&n(u,i,o),r=t(u).nest,e.forEach((function(e){r=r.filter((function(n){return n.key===e(i)}))[0].values})),r.splice(r.indexOf(i),1),u}},initial:function(e,n){return function(t){return t=e(t),n(t).nest=[],t}}},h={initial:function(e,n,t){return function(r){function u(e){return function(){return t[e](n(r))}}for(var i in e&&(r=e(r)),t)n(r)[i]=u(i);return r}}},p={add:function(e,n,t){return function(r,u,i){for(var o in n&&n(r,u,i),e)t(r)[o]=e[o](t(r),u);return r}}},A={add:function(e,n,t){return function(e,r,u){return n&&n(e,r,u),t(e).dataList.push(r),e}},remove:function(e,n,t){return function(e,r,u){return n&&n(e,r,u),t(e).dataList.splice(t(e).dataList.indexOf(r),1),e}},initial:function(e,n){return function(t){return e&&(t=e(t)),n(t).dataList=[],t}}},x={add:function(e,n,t){return function(n,r,u){return e&&e(n,r,u),t(n,r)}},remove:function(e,n,t){return function(n,r,u){return e&&e(n,r,u),t(n,r)}},initial:function(e,n,t){return function(n){return e&&(n=e(n)),t(n)}}};var y={build:function e(y,L,I){I||(I=function(e){return e});var b={reduceAdd:L.reduceAdd,reduceRemove:L.reduceRemove,reduceInitial:L.reduceInitial};(y.count||y.std)&&(L.reduceAdd=t.add(L.reduceAdd,I,y.count),L.reduceRemove=t.remove(L.reduceRemove,I,y.count),L.reduceInitial=t.initial(L.reduceInitial,I,y.count)),y.sum&&(L.reduceAdd=r.add(y.sum,L.reduceAdd,I),L.reduceRemove=r.remove(y.sum,L.reduceRemove,I),L.reduceInitial=r.initial(L.reduceInitial,I)),y.avg&&(y.count&&y.sum?(L.reduceAdd=u.add(y.sum,L.reduceAdd,I),L.reduceRemove=u.remove(y.sum,L.reduceRemove,I),L.reduceInitial=u.initial(L.reduceInitial,I)):console.error("You must set .count(true) and define a .sum(accessor) to use .avg(true).")),y.exceptionCount&&(y.exceptionAccessor?(L.reduceAdd=d.add(y.exceptionAccessor,L.reduceAdd,I),L.reduceRemove=d.remove(y.exceptionAccessor,L.reduceRemove,I),L.reduceInitial=d.initial(L.reduceInitial,I)):console.error("You must define an .exception(accessor) to use .exceptionCount(true).")),y.exceptionSum&&(y.exceptionAccessor?(L.reduceAdd=l.add(y.exceptionAccessor,y.exceptionSum,L.reduceAdd,I),L.reduceRemove=l.remove(y.exceptionAccessor,y.exceptionSum,L.reduceRemove,I),L.reduceInitial=l.initial(L.reduceInitial,I)):console.error("You must define an .exception(accessor) to use .exceptionSum(accessor).")),(y.valueList||y.median||y.min||y.max)&&(L.reduceAdd=s.add(y.valueList,L.reduceAdd,I),L.reduceRemove=s.remove(y.valueList,L.reduceRemove,I),L.reduceInitial=s.initial(L.reduceInitial,I)),y.dataList&&(L.reduceAdd=A.add(y.dataList,L.reduceAdd,I),L.reduceRemove=A.remove(y.dataList,L.reduceRemove,I),L.reduceInitial=A.initial(L.reduceInitial,I)),y.median&&(L.reduceAdd=i.add(L.reduceAdd,I),L.reduceRemove=i.remove(L.reduceRemove,I),L.reduceInitial=i.initial(L.reduceInitial,I)),y.min&&(L.reduceAdd=o.add(L.reduceAdd,I),L.reduceRemove=o.remove(L.reduceRemove,I),L.reduceInitial=o.initial(L.reduceInitial,I)),y.max&&(L.reduceAdd=c.add(L.reduceAdd,I),L.reduceRemove=c.remove(L.reduceRemove,I),L.reduceInitial=c.initial(L.reduceInitial,I)),y.exceptionAccessor&&(L.reduceAdd=a.add(y.exceptionAccessor,L.reduceAdd,I),L.reduceRemove=a.remove(y.exceptionAccessor,L.reduceRemove,I),L.reduceInitial=a.initial(L.reduceInitial,I)),y.histogramValue&&y.histogramThresholds&&(L.reduceAdd=f.add(y.histogramValue,L.reduceAdd,I),L.reduceRemove=f.remove(y.histogramValue,L.reduceRemove,I),L.reduceInitial=f.initial(y.histogramThresholds,L.reduceInitial,I)),y.sumOfSquares&&(L.reduceAdd=v.add(y.sumOfSquares,L.reduceAdd,I),L.reduceRemove=v.remove(y.sumOfSquares,L.reduceRemove,I),L.reduceInitial=v.initial(L.reduceInitial,I)),y.std&&(y.sumOfSquares&&y.sum?(L.reduceAdd=m.add(L.reduceAdd,I),L.reduceRemove=m.remove(L.reduceRemove,I),L.reduceInitial=m.initial(L.reduceInitial,I)):console.error("You must set .sumOfSq(accessor) and define a .sum(accessor) to use .std(true). Or use .std(accessor).")),y.custom&&(L.reduceAdd=x.add(L.reduceAdd,I,y.custom.add),L.reduceRemove=x.remove(L.reduceRemove,I,y.custom.remove),L.reduceInitial=x.initial(L.reduceInitial,I,y.custom.initial)),y.nestKeys&&(L.reduceAdd=g.add(y.nestKeys,L.reduceAdd,I),L.reduceRemove=g.remove(y.nestKeys,L.reduceRemove,I),L.reduceInitial=g.initial(L.reduceInitial,I)),y.aliasKeys&&(L.reduceInitial=h.initial(L.reduceInitial,I,y.aliasKeys)),y.aliasPropKeys&&(L.reduceAdd=p.add(y.aliasPropKeys,L.reduceAdd,I),L.reduceRemove=p.add(y.aliasPropKeys,L.reduceRemove,I)),y.filter&&(L.reduceAdd=n.add(y.filter,L.reduceAdd,b.reduceAdd,I),L.reduceRemove=n.remove(y.filter,L.reduceRemove,b.reduceRemove,I)),y.values&&Object.getOwnPropertyNames(y.values).forEach((function(n){var t;L.reduceInitial=(t=L.reduceInitial,function(e){return e=t(e),I(e)[n]={},e}),e(y.values[n].parameters,L,(function(e){return e[n]}))}))}},L=function(){return{order:!1,avg:!1,count:!1,sum:!1,exceptionAccessor:!1,exceptionCount:!1,exceptionSum:!1,filter:!1,valueList:!1,median:!1,histogramValue:!1,min:!1,max:!1,histogramThresholds:!1,std:!1,sumOfSquares:!1,values:!1,nestKeys:!1,aliasKeys:!1,aliasPropKeys:!1,groupAll:!1,dataList:!1,custom:!1}};function I(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),t=1;t<arguments.length;++t){var r=arguments[t];if(null!=r)for(var u in r)r.hasOwnProperty(u)&&(n[u]=r[u])}return n}var b={build:function e(n,t){function r(e){if("string"==typeof e){var n=e;return function(e){return e[n]}}return e}function u(e){if("string"==typeof e){var n=e;return function(e){return+e[n]}}return e}n.fromObject=function(e){return arguments.length?(I(t,e),n):t},n.toObject=function(){return t},n.count=function(e,r){return arguments.length?(r||(r="count"),t.count=r,n):t.count},n.sum=function(e){return arguments.length?(e=u(e),t.sum=e,n):t.sum},n.avg=function(e){return arguments.length?("function"==typeof(e=u(e))?(t.sum&&t.sum!==e&&console.warn("SUM aggregation is being overwritten by AVG aggregation"),t.sum=e,t.avg=!0,t.count="count"):t.avg=e,n):t.avg},n.exception=function(e){return arguments.length?(e=r(e),t.exceptionAccessor=e,n):t.exceptionAccessor},n.filter=function(e){return arguments.length?(t.filter=e,n):t.filter},n.valueList=function(e){return arguments.length?(e=r(e),t.valueList=e,n):t.valueList},n.median=function(e){return arguments.length?("function"==typeof(e=u(e))&&(t.valueList&&t.valueList!==e&&console.warn("VALUELIST accessor is being overwritten by median aggregation"),t.valueList=e),t.median=e,n):t.median},n.min=function(e){return arguments.length?("function"==typeof(e=u(e))&&(t.valueList&&t.valueList!==e&&console.warn("VALUELIST accessor is being overwritten by min aggregation"),t.valueList=e),t.min=e,n):t.min},n.max=function(e){return arguments.length?("function"==typeof(e=u(e))&&(t.valueList&&t.valueList!==e&&console.warn("VALUELIST accessor is being overwritten by max aggregation"),t.valueList=e),t.max=e,n):t.max},n.exceptionCount=function(e){return arguments.length?("function"==typeof(e=r(e))?(t.exceptionAccessor&&t.exceptionAccessor!==e&&console.warn("EXCEPTION accessor is being overwritten by exception count aggregation"),t.exceptionAccessor=e,t.exceptionCount=!0):t.exceptionCount=e,n):t.exceptionCount},n.exceptionSum=function(e){return arguments.length?(e=u(e),t.exceptionSum=e,n):t.exceptionSum},n.histogramValue=function(e){return arguments.length?(e=u(e),t.histogramValue=e,n):t.histogramValue},n.histogramBins=function(e){return arguments.length?(t.histogramThresholds=e,n):t.histogramThresholds},n.std=function(e){return arguments.length?("function"==typeof(e=u(e))?(t.sumOfSquares=e,t.sum=e,t.count="count",t.std=!0):t.std=e,n):t.std},n.sumOfSq=function(e){return arguments.length?(e=u(e),t.sumOfSquares=e,n):t.sumOfSquares},n.value=function(n,r){if(arguments.length&&"string"==typeof n)return t.values||(t.values={}),t.values[n]={},t.values[n].parameters=L(),e(t.values[n],t.values[n].parameters),r&&(t.values[n].accessor=r),t.values[n];console.error("'value' requires a string argument.")},n.nest=function(e){return arguments.length?(e.map(r),t.nestKeys=e,n):t.nestKeys},n.alias=function(e){return arguments.length?(t.aliasKeys=e,n):t.aliasKeys},n.aliasProp=function(e){return arguments.length?(t.aliasPropKeys=e,n):t.aliasPropKeys},n.groupAll=function(e){return arguments.length?(t.groupAll=e,n):t.groupAll},n.dataList=function(e){return arguments.length?(t.dataList=e,n):t.dataList},n.custom=function(e){return arguments.length?(t.custom=e,n):t.custom}}};var R=function(e){return function(n){return n[e]}};const S=function(e,n){return e||(e=function(e){return e}),function(t,r){n&&n(t,r);var u=e(t),i=e(r);return void 0!==i.count&&(u.count+=i.count),void 0!==i.sum&&(u.sum+=i.sum),void 0!==i.avg&&(u.avg=u.sum/u.count),t}},O=function(e,n,t){n.reduceInitial();var r=t.values?Object.keys(t.values):[],u=S();if(r.length)for(var i=0;i<r.length;++i)u=S(R(r[i]),u);return function(t,r){if(!arguments.length)return e();if(t===1/0||!t)return e();var i=e(),o=t-1;if(i.length<=t)return i;var c=i.slice(0,o),a={key:r||"Others"};a.value=n.reduceInitial();for(var s=o;s<i.length;++s)u(a.value,i[s].value);return c.push(a),c}};var q=function(e){if("function"==typeof e)return e;if(~e.indexOf(".")){var n=e.split(".");return function(e){return n.reduce((function(e,n){return e[n]}),e)}}return function(n){return n[e]}};function K(e,n){return e<n?-1:e>n?1:e>=n?0:NaN}var P=function(e,n){return function(t,r){return n(e(t),e(r))}};function w(e){return function(n,t){return 1===arguments.length&&(t=K),e().sort(P(q(n),t))}}function C(){var n=L(),t={};function r(r){if(t={reduceAdd:function(e){return e},reduceRemove:function(e){return e},reduceInitial:function(){return{}}},y.build(n,t),n.groupAll)if(r.top)console.warn("'groupAll' is defined but attempting to run on a standard dimension.group(). Must run on dimension.groupAll().");else{var u,i,o,c,a,s=e.bisect.by((function(e){return e.key})).left;r.reduce((function(e,r,d){for(o=n.groupAll(r),c=o.length,i=0;i<c;i++)a=o[i],e[u=s(e,a,0,e.length)]&&e[u].key===a||e.splice(u,0,{key:a,value:t.reduceInitial()}),t.reduceAdd(e[u].value,r,d);return e}),(function(e,r,a){for(o=n.groupAll(r),c=o.length,i=0;i<c;i++)u=s(e,o[i],0,e.length),t.reduceRemove(e[u].value,r,a);return e}),(function(){return[]})),r.all||(r.all=function(){return this.value()})}else r.reduce(t.reduceAdd,t.reduceRemove,t.reduceInitial);return V(r,n,t),r}return b.build(r,n),r}!function(e){e.postprocessors={},e.registerPostProcessor=function(n,t){e.postprocessors[n]=t},e.registerPostProcessor("cap",O),e.registerPostProcessor("sortBy",w)}(C);const V=function(e){return function(n,t,r){n.post=function(){var u=function(){return u.all()};u.all=function(){return n.all()};var i=e.postprocessors;return Object.keys(i).forEach((function(e){u[e]=function(){var n=u.all,o=[].slice.call(arguments);return u.all=function(){return i[e](n,r,t).apply(null,o)},u}})),u}}}(C);return C}));
